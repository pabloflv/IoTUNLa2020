<!DOCTYPE html>

<html lang="es">
<head>
    <link rel="icon" type="image/png" href="images/DB_16х16.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Material Dashboard Lite</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">


    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">


    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300,100,700,900' rel='stylesheet'
          type='text/css'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- inject:css -->
    <link rel="stylesheet" href="css/lib/getmdl-select.min.css">
    <link rel="stylesheet" href="css/lib/nv.d3.min.css">
    <link rel="stylesheet" href="css/application.min.css">
    <!-- endinject -->
<script src="js/d3.min.js"></script>
<script src="js/getmdl-select.min.js"></script>
<script src="js/material.min.js"></script>
<script src="js/nv.d3.min.js"></script>
<script src="js/layout/layout.min.js"></script>
<script src="js/scroll/scroll.min.js"></script>
<script src="js/widgets/charts/discreteBarChart.min.js"></script>
<script src="js/widgets/charts/linePlusBarChart.min.js"></script>
<script src="js/widgets/charts/stackedBarChart.min.js"></script>
<script src="js/widgets/employer-form/employer-form.min.js"></script>
<script src="js/widgets/line-chart/line-charts-nvd3.min.js"></script>
<script src="js/widgets/map/maps.min.js"></script>
<script src="js/widgets/pie-chart/pie-charts-nvd3.min.js"></script>
<script src="js/widgets/table/table.min.js"></script>
<script src="js/widgets/todo/todo.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js" integrity="sha256-qSIshlknROr4J8GMHRlW3fGKrPki733tLq+qeMCR05Q=" crossorigin="anonymous"></script>
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145830444-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-145830444-2');
</script>





<script type="text/javascript">
  function change_device(){

    var device_id = $("#device_select").val();
    console.log(device_id);
    $.post("devices/change_device", {device_id: device_id}, function(result){
      location.reload();
    });
  }
</script>
<!-- endinject -->

<style media="screen">
/* The switch - the box around the slider */
.switch {
position: relative;
display: inline-block;
width: 42px;
height: 24px;
}

/* Hide default HTML checkbox */
.switch input {
opacity: 0;
width: 0;
height: 0;
}

/* The slider */
.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #ccc;
-webkit-transition: .4s;
transition: .4s;
}

.slider:before {
position: absolute;
content: "";
height: 16px;
width: 16px;
left: 4px;
bottom: 4px;
background-color: white;
-webkit-transition: .4s;
transition: .4s;
}

input:checked + .slider {
background-color: #2196F3;
}

input:focus + .slider {
box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
-webkit-transform: translateX(16px);
-ms-transform: translateX(16px);
transform: translateX(16px);
}

/* Rounded sliders */
.slider.round {
border-radius: 18px;
}

.slider.round:before {
border-radius: 50%;
}
</style>

</head>



<body>




  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header is-small-screen">

  <main class="mdl-layout__content">

  <div class="mdl-grid mdl-grid--no-spacing dashboard">

    <div class="mdl-grid mdl-cell mdl-cell--9-col-desktop mdl-cell--12-col-tablet mdl-cell--4-col-phone mdl-cell--top">

      <!-- TEMP -->
      <div class="mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--2-col-phone">
        <div class="mdl-card mdl-shadow--2dp weather">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Sensor 1</h2>

            <div class="mdl-layout-spacer"></div>
            <div class="mdl-card__subtitle-text">
              <i class="material-icons">room</i>
              Ubicación, Argentina
            </div>
          </div>
          <div class="mdl-card__supporting-text mdl-card--expand">
            <p id="display_temp" class="weather-temperature">--</p>

            <p style="font-size:16px;position:relative;color:#fff">
              Partes por millón
            </p>
          </div>
        </div>
      </div>
      <!-- HUM -->
      <div class="mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--2-col-phone">
        <div class="mdl-card mdl-shadow--2dp weather">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Sensor 2</h2>

            <div class="mdl-layout-spacer"></div>
            <div class="mdl-card__subtitle-text">
              <i class="material-icons">room</i>
              Ubicación, Argentina
            </div>
          </div>
          <div class="mdl-card__supporting-text mdl-card--expand">
            <p id="display_hum" class="weather-temperature">--</p>

            <p class="weather-description">
              Cloudy and snow
            </p>
          </div>
        </div>
      </div>
      <!-- Trending widget-->
      <div class="mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--2-col-phone">
        <div class="mdl-card mdl-shadow--2dp trending">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Actuadores</h2>
          </div>
          <div class="mdl-card__supporting-text">
            <ul class="mdl-list">

              <li class="mdl-list__item">
                <span class="mdl-list__item-primary-content list__item-text">Actuador 1</span>
                <span class="mdl-list__item-secondary-content">


                  <!-- SWITCH-->
                  <label class="switch">
                    <input onchange="sw1_change()" type="checkbox" id="display_sw1">
                    <span class="slider round"></span>
                  </label>

                </span>
              </li>

              <li class="mdl-list__item list__item--border-top">

                <span class="mdl-list__item-primary-content list__item-text">Actuador 2</span>
                <span class="mdl-list__item-secondary-content">

                  <!-- SWITCH-->
                  <label class="switch">
                    <input onchange="sw2_change()" type="checkbox" id="display_sw2">
                    <span class="slider round"></span>
                  </label>

                </span>
              </li>

              <li class="mdl-list__item list__item--border-top">

                <span class="mdl-list__item-primary-content list__item-text">Actuador 3</span>
                <span class="mdl-list__item-secondary-content">

                  <input onchange="slider_change()" id="display_slider" class="mdl-slider mdl-js-slider slider--colored-light-blue" type="range" min="0" max="254" value="0" tabindex="0">

                </span>
              </li>


            </ul>
          </div>
        </div>
      </div>
      <!-- Cotoneaster card-->

      <!-- Line chart-->
      <div class="mdl-cell mdl-cell--12-col-desktop mdl-cell--12-col-tablet mdl-cell--4-col-phone">
        <div class="mdl-card mdl-shadow--2dp line-chart">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Sensor 1</h2>
          </div>
          <div class="mdl-card__supporting-text">
            <canvas id="my_chart" width="300" height="300"  ></canvas>
          </div>
        </div>
      </div>
      <!-- Table-->


      <!-- Line chart2-->
      <div class="mdl-cell mdl-cell--12-col-desktop mdl-cell--12-col-tablet mdl-cell--4-col-phone">
        <div class="mdl-card mdl-shadow--2dp line-chart">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Sensor 2</h2>
          </div>
          <div class="mdl-card__supporting-text">
            <canvas id="my_chart2" width="300" height="300"  ></canvas>
          </div>
        </div>
      </div>
      <!-- Table-->

    </div>

    </div>

</main>

<script>
var ctx = document.getElementById('my_chart').getContext('2d');
var ctx2 = document.getElementById('my_chart2').getContext('2d');


var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|','|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|', '|', '|', '|', '|', '|', '|'],
        datasets: [{
            label: '° C',
            data: ['0', '0','0', '0', '0', '0','0', '0','0', '0', '0', '0','0', '0','0', '0', '0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0',],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
            ],
            borderWidth: 1
        }]
    },
    options: {
      maintainAspectRatio: false,
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});


var myChart2 = new Chart(ctx2, {
    type: 'line',
    data: {
        labels: ['|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|','|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|','|', '|', '|', '|', '|', '|', '|', '|', '|'],
        datasets: [{
            label: '%',
            data: ['0', '0','0', '0', '0', '0','0', '0','0', '0', '0', '0','0', '0','0', '0', '0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0','0', '0',],
            backgroundColor: [
                'rgba(30, 170, 132, 0.2)',
            ],
            borderColor: [
                'rgba(30, 170, 132, 1)',
            ],
            borderWidth: 1
        }]
    },
    options: {
      maintainAspectRatio: false,
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});

function agregarValor(chart, etiqueta, valor) {
    if(chart.data.datasets[0].data.length ==40){
    chart.data.datasets[0].data.shift();  
    }
     
    chart.data.datasets[0].data.push(valor);
    
    chart.update();
}


const options = {
  connectTimeout: 1000,
  // Authentication
  clientId: 'mqttjs_bcbc4f2991'+ Math.floor((Math.random() * 1000000) + 1),
  username: '',
  password: '',
  keepalive: 60,
  clean: true,
}

// WebSocket connect url
const WebSocket_URL = 'ws://35.199.99.14:8083/mqtt'
const client = mqtt.connect(WebSocket_URL, options)

var device_topic = 'sensores&actuadores';
client.on('connect', () => {
  console.log('Connect success');

  client.subscribe(device_topic, { qos: 0 }, (error) => {
    if(error){
      console.log("Error at subscribe");
    }else{
      console.log("Subscribe ok: "+device_topic);
    }

  })
})

client.on('message', (topic, message) => {
  console.log('Msg from topic: ', topic, ' ----> ', message.toString());

  
    var splitted = message.toString().split(",");

    var temp = splitted[0];
    var hum = splitted[1];
    var switch1 = splitted[2];
    var switch2 = splitted[3];
    agregarValor(myChart, "2", splitted[0]);
    agregarValor(myChart2, "2", splitted[1]);
    $("#display_hum").html(hum);
    $("#display_temp").html(temp);
    
    document.getElementById('display_slider').value = splitted[4];
   
    if(switch1 == "1"){
      $("#display_sw1").prop('checked', true);
    }else{
      $("#display_sw1").prop('checked',"");
    }

    if(switch2 == "1"){
      $("#display_sw2").prop('checked', true);
    }else{
      $("#display_sw2").prop('checked',"" );
    }


  


})

client.on('reconnect', (error) => {
  console.log('reconnecting:', error);
})

client.on('error', (error) => {
  console.log('Connect Error:', error);
})

function sw1_change(){
  if ($('#display_sw1').is(":checked"))
  {
    client.publish(device_topic + 'actions/sw1',"1");
  }else{
    client.publish(device_topic + 'actions/sw1',"0");
  }
}

function sw2_change(){
  if ($('#display_sw2').is(":checked"))
  {
    client.publish(device_topic + 'actions/sw2',"1");
  }else{
    client.publish(device_topic + 'actions/sw2',"0");
  }
}

function slider_change(){
  value = $('#display_slider').val();
  client.publish(device_topic + 'actions/slider',value);
}



</script>
 </body>
</html>